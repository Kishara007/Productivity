<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Interactive Productivity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .main-container {
            position: relative;
            z-index: 1;
        }
        .panel {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .timetable-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .timetable-scroll::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .timetable-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .task-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border-left-width: 4px;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .task-card.completed {
            background-color: #f0fdfa !important; /* teal-50 */
            opacity: 0.7;
        }
        .task-card.completed .task-title { text-decoration: line-through; text-decoration-color: #14b8a6; }
        .modal-overlay { transition: opacity 0.3s ease; background: rgba(30, 41, 59, 0.6); }
        .modal-content { transition: transform 0.3s ease; }
        .day-column.today {
            background-color: #f0f9ff; /* sky-50 */
            border: 1px solid #bae6fd; /* sky-200 */
        }
        .tab-btn {
            transition: all 0.3s ease-in-out;
            position: relative;
            color: #475569; /* slate-600 */
        }
        .tab-btn.active {
            color: #0f766e; /* teal-700 */
        }
        .tab-btn:before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: #14b8a6; /* teal-500 */
            border-radius: 2px;
            transition: width 0.3s ease-in-out;
        }
        .tab-btn.active:before {
            width: 70%;
        }
        .progress-bar-container { background-color: #e2e8f0; border-radius: 0.5rem; overflow: hidden; }
        .progress-bar {
            background: #2dd4bf; /* teal-400 */
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary {
            background-color: #14b8a6; /* teal-500 */
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0f766e; /* teal-700 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .suggestion-btn, .duration-btn {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #475569;
            transition: all 0.2s ease-in-out;
        }
        .suggestion-btn.selected, .duration-btn.selected {
            background-color: #14b8a6;
            color: white;
            border-color: #14b8a6;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .duration-btn:disabled {
            background-color: #f8fafc;
            color: #cbd5e1;
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: none;
        }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="main-dashboard" class="main-container container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-2 tracking-tight">Productivity Dashboard</h1>
            <p class="text-lg text-slate-500 mb-6">Focus, Progress, and Rewards, Reimagined.</p>
            <button id="add-new-task-main" class="btn-primary text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Add New Task
            </button>
        </header>

        <nav class="mb-8 flex justify-center bg-white/70 backdrop-blur-sm p-2 rounded-xl shadow-sm">
            <button data-tab="dashboard" class="tab-btn active font-semibold py-2 px-6 rounded-lg">Dashboard</button>
            <button data-tab="analytics" class="tab-btn font-semibold py-2 px-6 rounded-lg">Analytics</button>
            <button data-tab="plan" class="tab-btn font-semibold py-2 px-6 rounded-lg">My Plan</button>
        </nav>

        <main>
            <div id="dashboard" class="tab-content">
                <section id="dashboard-stats" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="panel p-6 text-center">
                        <div id="planned-hours" class="text-5xl font-black text-slate-800">0.0</div>
                        <div class="text-sm font-semibold text-teal-600 mt-1 tracking-wider">PLANNED HOURS</div>
                    </div>
                    <div class="panel p-6 text-center">
                        <div id="actual-hours" class="text-5xl font-black text-slate-800">0.0</div>
                        <div class="text-sm font-semibold text-teal-600 mt-1 tracking-wider">ACTUAL HOURS</div>
                    </div>
                    <div class="panel p-6 text-center">
                        <div id="completion-rate" class="text-5xl font-black text-slate-800">0%</div>
                        <div class="text-sm font-semibold text-teal-600 mt-1 tracking-wider">COMPLETION</div>
                    </div>
                </section>
                <section id="interactive-timetable" class="panel p-4 md:p-6">
                    <h2 class="text-2xl font-bold text-center mb-6 text-slate-700">This Week's Schedule</h2>
                    <div id="timetable-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4 timetable-scroll overflow-x-auto pb-4"></div>
                </section>
            </div>

            <div id="analytics" class="tab-content hidden">
                 <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="panel p-6"><h2 class="text-2xl font-bold mb-4 text-slate-700">Weekly Earnings Progress</h2><div class="mb-4"><div class="flex justify-between items-end mb-1"><span class="font-bold text-lg text-slate-600">Weekly Earnings</span><div><span id="weekly-points-earned" class="font-extrabold text-2xl text-teal-600">$0</span></div></div><div class="progress-bar-container h-4 w-full"><div id="weekly-progress-bar" class="progress-bar h-4"></div></div></div></div>
                    <div class="panel p-6"><h2 class="text-2xl font-bold mb-4 text-slate-700">Daily Earnings Breakdown</h2><div class="h-64"><canvas id="analytics-points-chart"></canvas></div></div>
                    <div class="panel p-6"><h2 class="text-2xl font-bold mb-4 text-slate-700">Category Completion</h2><div class="h-64"><canvas id="analytics-category-chart"></canvas></div></div>
                    <div class="panel p-6"><h2 class="text-2xl font-bold mb-4 text-slate-700">Weekly Hours</h2><div class="h-64"><canvas id="analytics-hours-chart"></canvas></div></div>
                </section>
            </div>

            <div id="plan" class="tab-content hidden">
               <section class="space-y-8">
                    <div class="panel p-6"><h2 class="text-2xl font-bold mb-4 text-slate-700">Weekly Progress</h2><p class="text-slate-500 mb-4">Completed hours vs. total scheduled hours for the week.</p><div class="progress-bar-container h-6 w-full"><div id="plan-weekly-progress" class="progress-bar h-6 flex items-center justify-center text-white font-bold"></div></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="panel p-6"><h2 class="text-2xl font-bold mb-4 text-slate-700">Category Allocation</h2><p class="text-slate-500 mb-4">Breakdown of scheduled hours by category.</p><div class="h-64"><canvas id="plan-weekday-allocation-chart"></canvas></div></div>
                        <div class="panel p-6"><h2 class="text-2xl font-bold mb-4 text-slate-700">Earnings by Category</h2><p class="text-slate-500 mb-4">Total potential earnings from each category.</p><div class="h-64"><canvas id="plan-growth-focus-chart"></canvas></div></div>
                    </div>
               </section>
            </div>
        </main>
    </div>

    <div id="task-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content panel w-full max-w-md p-6 transform scale-95">
            <div class="flex justify-between items-center mb-4"><h3 id="modal-title" class="text-2xl font-bold text-slate-800">Task Details</h3><button id="close-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold">&times;</button></div>
            <div id="modal-view-content">
                <p id="modal-task-time" class="text-lg text-slate-500 mb-4"></p>
                <div id="pomodoro-timer" class="text-center hidden my-4 p-4 bg-slate-100 rounded-lg">
                    <div id="timer-display" class="text-7xl font-black text-slate-800 my-2">25:00</div>
                    <div id="timer-status" class="text-lg font-semibold text-teal-600 mb-4">Ready to focus?</div>
                    <div class="flex justify-center gap-4">
                        <button id="start-pause-btn" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">Start</button>
                        <button id="reset-btn" class="bg-slate-300 text-slate-800 px-6 py-2 rounded-lg font-semibold hover:bg-slate-400 transition">Reset</button>
                    </div>
                </div>
                <div id="modal-view-buttons" class="mt-6 space-y-3">
                    <button id="complete-task-btn" class="btn-primary text-white w-full py-3 rounded-lg font-bold shadow-md hover:shadow-lg transform hover:scale-105 transition-all">Mark as Complete</button>
                    <div class="flex gap-3">
                        <button id="edit-task-btn" class="bg-slate-500 text-white w-full py-2 rounded-lg font-bold hover:bg-slate-600 transition">Edit</button>
                        <button id="delete-task-btn" class="btn-danger text-white w-full py-2 rounded-lg font-bold">Delete</button>
                    </div>
                </div>
                <div id="modal-delete-confirm" class="hidden mt-4 p-4 bg-red-100 border border-red-300 rounded-lg text-center">
                    <p class="font-semibold text-red-800 mb-3">Are you sure?</p>
                    <div class="flex gap-3">
                        <button id="confirm-delete-btn" class="btn-danger text-white w-full py-2 rounded-lg font-bold">Yes, Delete</button>
                        <button id="cancel-delete-btn" class="bg-slate-300 text-slate-800 w-full py-2 rounded-lg font-bold hover:bg-slate-400 transition">Cancel</button>
                    </div>
                </div>
            </div>
            <div id="modal-form-content" class="hidden">
                 <form id="modal-task-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="modal-task-title-input" class="block text-sm font-bold text-slate-600 mb-1">Task Title</label>
                        <input type="text" id="modal-task-title-input" class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md text-slate-800" required>
                        <div id="task-suggestion-buttons" class="flex flex-wrap gap-2 mt-2">
                            <!-- Task suggestion buttons injected by JS -->
                        </div>
                    </div>
                    <div><label for="modal-task-day" class="block text-sm font-bold text-slate-600 mb-1">Day</label><select id="modal-task-day" class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md text-slate-800"><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option></select></div>
                    <div><label for="modal-task-category" class="block text-sm font-bold text-slate-600 mb-1">Category</label><select id="modal-task-category" class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md text-slate-800"><option value="growth">Growth</option><option value="work">Work</option><option value="health">Health</option><option value="personal">Personal</option><option value="relax">Relax</option></select></div>
                    
                    <div class="md:col-span-2 space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-600 mb-2">1. Select Task Duration</label>
                            <div id="duration-buttons" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div id="time-slot-container" class="hidden">
                            <label for="time-slot-dropdown" class="block text-sm font-bold text-slate-600 mb-2">2. Select Available Slot</label>
                            <select id="time-slot-dropdown" class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md text-slate-800"></select>
                        </div>
                        <button type="button" id="custom-time-toggle-btn" class="text-sm text-teal-600 hover:text-teal-700 font-semibold underline">Or Set Custom Time</button>
                        <div id="custom-time-inputs" class="hidden grid grid-cols-2 gap-4 mt-2">
                            <div><label for="modal-task-start-time" class="block text-sm font-bold text-slate-600 mb-1">Start Time</label><input type="time" id="modal-task-start-time" class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md text-slate-800"></div>
                            <div><label for="modal-task-end-time" class="block text-sm font-bold text-slate-600 mb-1">End Time</label><input type="time" id="modal-task-end-time" class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md text-slate-800"></div>
                        </div>
                    </div>

                    <div><label for="modal-task-points" class="block text-sm font-bold text-slate-600 mb-1">Reward ($)</label><input type="number" id="modal-task-points" value="1" min="0" class="w-full p-2 bg-slate-100 border border-slate-300 rounded-md text-slate-800"></div>
                    <div class="flex items-center h-full mt-4"><input type="checkbox" id="modal-task-pomodoro" class="h-5 w-5 rounded mr-2 border-slate-400 text-teal-500 focus:ring-teal-500"><label for="modal-task-pomodoro" class="text-sm font-bold text-slate-600">Use Pomodoro?</label></div>
                    <div class="md:col-span-2 mt-4 flex gap-3"><button type="submit" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg">Save Task</button><button type="button" id="cancel-edit-btn" class="w-full bg-slate-300 text-slate-800 font-bold py-3 px-4 rounded-lg hover:bg-slate-400 transition">Cancel</button></div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 2D Background Setup ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        const mouse = { x: null, y: null, radius: (canvas.height / 120) * (canvas.width / 120) };
        window.addEventListener('mousemove', e => { mouse.x = e.x; mouse.y = e.y; });
        window.addEventListener('mouseout', () => { mouse.x = null; mouse.y = null; });
        class Particle {
            constructor(x, y, directionX, directionY, size, color) { this.x = x; this.y = y; this.directionX = directionX; this.directionY = directionY; this.size = size; this.color = color; }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); ctx.fillStyle = 'rgba(14, 165, 233, 0.2)'; ctx.fill(); }
            update() { if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX; if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY; this.x += this.directionX; this.y += this.directionY; this.draw(); }
        }
        function initParticles() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 3) + 1;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * 0.4) - 0.2;
                let directionY = (Math.random() * 0.4) - 0.2;
                particlesArray.push(new Particle(x, y, directionX, directionY, size, '#94a3b8'));
            }
        }
        function connect() {
            let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = ((particlesArray[a].x - particlesArray[b].x) ** 2) + ((particlesArray[a].y - particlesArray[b].y) ** 2);
                    if (distance < (canvas.width / 7) * (canvas.height / 7)) {
                        opacityValue = 1 - (distance / 20000);
                        ctx.strokeStyle = `rgba(2, 132, 199, ${opacityValue * 0.3})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath(); ctx.moveTo(particlesArray[a].x, particlesArray[a].y); ctx.lineTo(particlesArray[b].x, particlesArray[b].y); ctx.stroke();
                    }
                }
            }
        }
        function animate2D() { requestAnimationFrame(animate2D); ctx.clearRect(0, 0, innerWidth, innerHeight); for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); } connect(); }
        initParticles(); animate2D();
        window.addEventListener('resize', () => { canvas.width = innerWidth; canvas.height = innerHeight; mouse.radius = (canvas.height / 120) * (canvas.width / 120); initParticles(); });

        // --- Globals & UI Elements ---
        let schedule = {}, taskStates = {}, charts = {};
        const today = new Date().getDay();
        const modal = document.getElementById('task-modal'), modalTitle = document.getElementById('modal-title'), modalViewContent = document.getElementById('modal-view-content'), modalFormContent = document.getElementById('modal-form-content'), modalTaskForm = document.getElementById('modal-task-form'), modalDeleteConfirm = document.getElementById('modal-delete-confirm'), modalViewButtons = document.getElementById('modal-view-buttons'), taskSuggestionButtonsContainer = document.getElementById('task-suggestion-buttons'), durationButtonsContainer = document.getElementById('duration-buttons'), timeSlotContainer = document.getElementById('time-slot-container'), timeSlotDropdown = document.getElementById('time-slot-dropdown'), customTimeInputs = document.getElementById('custom-time-inputs'), customTimeToggleBtn = document.getElementById('custom-time-toggle-btn'), daySelectInModal = document.getElementById('modal-task-day');

        // --- Constants ---
        const categoryColors = { health: 'bg-sky-100 border-sky-400', personal: 'bg-slate-100 border-slate-400', work: 'bg-red-100 border-red-400', growth: 'bg-green-100 border-green-400', relax: 'bg-purple-100 border-purple-400' };
        const chartCategoryColors = { health: '#38bdf8', personal: '#94a3b8', work: '#f87171', growth: '#4ade80', relax: '#a78bfa' };
        const DURATION_OPTIONS = [ { label: '15m', value: 15 }, { label: '30m', value: 30 }, { label: '45m', value: 45 }, { label: '1h', value: 60 }, { label: '1h 30m', value: 90 }, { label: '2h', value: 120 } ];
        const TASK_SUGGESTIONS = ['Breakfast', 'Exercise', 'Reading', 'Planning', 'Meditation', 'Lunch', 'Dinner', 'Work Block'];

        // --- Pomodoro Timer ---
        const pomodoro = {
            timer: null, mode: 'work', timeLeft: 1500, isRunning: false, workDuration: 1500, breakDuration: 300,
            display: document.getElementById('timer-display'), statusDisplay: document.getElementById('timer-status'), startPauseBtn: document.getElementById('start-pause-btn'),
            start() { if (this.isRunning) return; this.isRunning = true; this.startPauseBtn.textContent = 'Pause'; this.statusDisplay.textContent = this.mode === 'work' ? 'Time to focus!' : 'Time for a break!'; this.timer = setInterval(() => { this.timeLeft--; this.updateDisplay(); if (this.timeLeft <= 0) { this.stop(); this.mode = this.mode === 'work' ? 'break' : 'work'; this.timeLeft = this.mode === 'work' ? this.workDuration : this.breakDuration; this.statusDisplay.textContent = this.mode === 'work' ? "Break's over!" : "Good work! Take a break."; try { new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg").play(); } catch(e) { console.error("Audio playback failed", e); } } }, 1000); },
            pause() { if (!this.isRunning) return; this.isRunning = false; this.startPauseBtn.textContent = 'Start'; clearInterval(this.timer); },
            stop() { clearInterval(this.timer); this.isRunning = false; },
            reset(duration = 1500, mode = 'work') { this.stop(); this.mode = mode; this.timeLeft = duration; this.startPauseBtn.textContent = 'Start'; this.statusDisplay.textContent = 'Ready to focus?'; this.updateDisplay(); },
            updateDisplay() { const m = Math.floor(this.timeLeft / 60); const s = this.timeLeft % 60; this.display.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; }
        };
        
        // --- Data Persistence ---
        function saveSchedule() { localStorage.setItem('userProductivityScheduleV5', JSON.stringify(schedule)); }
        function loadSchedule() { const s = localStorage.getItem('userProductivityScheduleV5'); schedule = s ? JSON.parse(s) : { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] }; }
        function saveTaskStates() { localStorage.setItem('productivityTaskStatesV5', JSON.stringify(taskStates)); }
        function loadTaskStates() { const s = localStorage.getItem('productivityTaskStatesV5'); taskStates = s ? JSON.parse(s) : {}; Object.values(schedule).flat().forEach(task => { if (!taskStates[task.id]) taskStates[task.id] = { completed: false }; }); }

        // --- Core App Logic ---
        function init() { loadSchedule(); loadTaskStates(); renderTimetable(); updateAll(); setupDashboardEventListeners(); }

        // --- CRUD Functions ---
        function handleSaveTask(e) {
            e.preventDefault();
            const taskId = modal.dataset.currentTaskId;
            const title = document.getElementById('modal-task-title-input').value, day = document.getElementById('modal-task-day').value, category = document.getElementById('modal-task-category').value, startTime = document.getElementById('modal-task-start-time').value, endTime = document.getElementById('modal-task-end-time').value, points = parseInt(document.getElementById('modal-task-points').value, 10), pomodoro = document.getElementById('modal-task-pomodoro').checked;
            if (!title || !startTime || !endTime) { alert("Please select a time slot or enter a custom time."); return; }
            const start = new Date(`1970-01-01T${startTime}:00`), end = new Date(`1970-01-01T${endTime}:00`);
            if (end <= start) { alert("End time must be after start time."); return; }
            const duration = (end - start) / (1000 * 60 * 60);
            const taskData = { title, category, points, pomodoro, time: `${startTime} - ${endTime}`, duration: parseFloat(duration.toFixed(2)) };
            if (taskId) {
                const oldTaskDay = findTaskDay(taskId), taskIndex = schedule[oldTaskDay].findIndex(t => t.id == taskId), originalTask = schedule[oldTaskDay][taskIndex], updatedTask = { ...originalTask, ...taskData };
                if (oldTaskDay != day) { schedule[oldTaskDay].splice(taskIndex, 1); if (!schedule[day]) schedule[day] = []; schedule[day].push(updatedTask); } else { schedule[oldTaskDay][taskIndex] = updatedTask; }
            } else { taskData.id = Date.now(); if (!schedule[day]) schedule[day] = []; schedule[day].push(taskData); taskStates[taskData.id] = { completed: false }; }
            saveSchedule(); saveTaskStates(); renderTimetable(); updateAll(); closeModal();
        }
        function promptForDelete() { modalViewButtons.classList.add('hidden'); modalDeleteConfirm.classList.remove('hidden'); }
        function cancelDeletePrompt() { modalViewButtons.classList.remove('hidden'); modalDeleteConfirm.classList.add('hidden'); }
        function executeDelete() { const taskId = modal.dataset.currentTaskId, day = findTaskDay(taskId); if (day !== -1) { schedule[day] = schedule[day].filter(t => t.id != taskId); delete taskStates[taskId]; saveSchedule(); saveTaskStates(); renderTimetable(); updateAll(); closeModal(); } }
        function findTaskDay(taskId) { for (const day in schedule) { if (schedule[day].some(t => t.id == taskId)) return day; } return -1; }

        // --- Time Suggestion Logic ---
        function timeStringToMinutes(timeStr) { const [hours, minutes] = timeStr.split(':').map(Number); return hours * 60 + minutes; }
        function minutesToTimeString(minutes) { const h = Math.floor(minutes / 60).toString().padStart(2, '0'); const m = (minutes % 60).toString().padStart(2, '0'); return `${h}:${m}`; }
        
        function updateDurationButtons(dayIndex, taskIdToIgnore = null) {
            const freeSlots = findFreeTimeSlots(dayIndex, taskIdToIgnore);
            const maxFreeDuration = Math.max(0, ...freeSlots.map(slot => slot.end - slot.start));
            
            durationButtonsContainer.innerHTML = '';
            DURATION_OPTIONS.forEach(opt => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'duration-btn px-3 py-1 rounded-md text-sm font-semibold transition';
                btn.textContent = opt.label;
                btn.dataset.duration = opt.value;
                btn.disabled = opt.value > maxFreeDuration;
                durationButtonsContainer.appendChild(btn);
            });
            timeSlotContainer.classList.add('hidden');
        }

        function populateTimeSlotsForDuration(dayIndex, duration, taskIdToIgnore = null) {
            const freeSlots = findFreeTimeSlots(dayIndex, taskIdToIgnore);
            let optionsHtml = '<option value="" selected disabled>Select a time...</option>';
            
            freeSlots.forEach(slot => {
                if (slot.end - slot.start >= duration) {
                    let currentTime = slot.start;
                    while (currentTime + duration <= slot.end) {
                        const endTime = currentTime + duration;
                        optionsHtml += `<option data-start-time="${minutesToTimeString(currentTime)}" data-end-time="${minutesToTimeString(endTime)}">${minutesToTimeString(currentTime)} - ${minutesToTimeString(endTime)}</option>`;
                        currentTime += 15; // Suggest slots every 15 minutes
                    }
                }
            });

            if (optionsHtml === '<option value="" selected disabled>Select a time...</option>') {
                optionsHtml = '<option value="" selected disabled>No slots for this duration.</option>';
            }
            
            timeSlotDropdown.innerHTML = optionsHtml;
            timeSlotContainer.classList.remove('hidden');
        }

        function findFreeTimeSlots(dayIndex, taskIdToIgnore = null) {
            const tasksForDay = (schedule[dayIndex] || []).filter(task => task.id != taskIdToIgnore).map(task => { const [start, end] = task.time.split(' - '); return { start: timeStringToMinutes(start), end: timeStringToMinutes(end) }; }).sort((a, b) => a.start - b.start);
            const freeSlots = []; let lastEndTime = 0;
            tasksForDay.forEach(task => { if (task.start > lastEndTime) { freeSlots.push({ start: lastEndTime, end: task.start }); } lastEndTime = Math.max(lastEndTime, task.end); });
            if (lastEndTime < 1440) { freeSlots.push({ start: lastEndTime, end: 1440 }); }
            return freeSlots;
        }

        function populateTaskSuggestions() {
            taskSuggestionButtonsContainer.innerHTML = '';
            TASK_SUGGESTIONS.forEach(taskName => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'suggestion-btn px-3 py-1 rounded-md text-xs font-semibold';
                btn.textContent = taskName;
                btn.dataset.taskName = taskName;
                taskSuggestionButtonsContainer.appendChild(btn);
            });
        }

        // --- Rendering ---
        function renderTimetable() {
            const grid = document.getElementById('timetable-grid'); grid.innerHTML = '';
            const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            daysOfWeek.forEach((day, index) => {
                const dayColumn = document.createElement('div'); dayColumn.className = `day-column p-3 rounded-lg space-y-3 ${index === today ? 'today' : 'bg-slate-100'}`;
                dayColumn.innerHTML = `<h3 class="text-center font-bold text-lg text-slate-600">${day}</h3>`;
                const tasks = schedule[index] || [];
                if (tasks.length === 0) { dayColumn.innerHTML += `<div class="text-center text-xs text-slate-400 pt-4">No tasks.</div>`; } else {
                    tasks.sort((a,b) => a.time.localeCompare(b.time)).forEach(task => {
                        const taskCard = document.createElement('div');
                        taskCard.className = `task-card p-3 rounded-lg ${categoryColors[task.category]} ${taskStates[task.id]?.completed ? 'completed' : ''}`;
                        taskCard.dataset.taskId = task.id;
                        taskCard.innerHTML = `<p class="font-bold text-slate-800 task-title">${task.title}</p><p class="text-sm text-slate-500">${task.time}</p><p class="text-xs font-bold text-slate-600 mt-1">Reward: $${task.points}</p>`;
                        dayColumn.appendChild(taskCard);
                    });
                }
                grid.appendChild(dayColumn);
            });
        }
        function updateAll() {
            updateDashboard();
            if (!document.getElementById('analytics').classList.contains('hidden')) updateAnalytics();
            if (!document.getElementById('plan').classList.contains('hidden')) updatePlanVisuals();
        }
        function updateDashboard() {
            const todayTasks = schedule[today] || [], plannedHours = todayTasks.reduce((sum, task) => sum + task.duration, 0), actualHours = todayTasks.reduce((sum, task) => (taskStates[task.id]?.completed ? sum + task.duration : sum), 0), completionRate = plannedHours > 0 ? (actualHours / plannedHours) * 100 : 0;
            document.getElementById('planned-hours').textContent = plannedHours.toFixed(1);
            document.getElementById('actual-hours').textContent = actualHours.toFixed(1);
            document.getElementById('completion-rate').textContent = `${Math.round(completionRate)}%`;
        }
        function createOrUpdateChart(chartId, type, labels, datasets, options = {}) {
            const ctx = document.getElementById(chartId)?.getContext('2d'); if(!ctx) return;
            if (charts[chartId]) charts[chartId].destroy();
            const defaultOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#475569' } } }, scales: { x: { ticks: { color: '#64748b' }, grid: { color: '#e2e8f0' } }, y: { ticks: { color: '#64748b' }, grid: { color: '#e2e8f0' }, beginAtZero: true } } };
            charts[chartId] = new Chart(ctx, { type, data: { labels, datasets }, options: {...defaultOptions, ...options} });
        }
        function updateAnalytics() {
            const pointsPerDay = [0, 0, 0, 0, 0, 0, 0], categoryCompletion = { health: {t:0, c:0}, personal: {t:0, c:0}, work: {t:0, c:0}, growth: {t:0, c:0}, relax: {t:0, c:0} }, weeklyHours = { planned: 0, actual: 0 }, allTasks = Object.values(schedule).flat();
            allTasks.forEach(task => { const dayOfTask = findTaskDay(task.id); categoryCompletion[task.category].t++; weeklyHours.planned += task.duration; if(taskStates[task.id]?.completed) { pointsPerDay[dayOfTask] += task.points; categoryCompletion[task.category].c++; weeklyHours.actual += task.duration; } });
            const totalPoints = pointsPerDay.reduce((a, b) => a + b, 0), totalPossiblePoints = allTasks.reduce((sum, task) => sum + task.points, 0), progressPercent = totalPossiblePoints > 0 ? (totalPoints / totalPossiblePoints) * 100 : 0;
            document.getElementById('weekly-points-earned').textContent = `$${totalPoints} / $${totalPossiblePoints}`; document.getElementById('weekly-progress-bar').style.width = `${Math.min(progressPercent, 100)}%`;
            createOrUpdateChart('analytics-points-chart', 'bar', ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], [{ label: 'Earned ($)', data: pointsPerDay, backgroundColor: '#2dd4bf', borderRadius: 5 }], { plugins: { legend: { display: false } } });
            const catLabels = Object.keys(categoryCompletion), catData = catLabels.map(cat => categoryCompletion[cat].t > 0 ? (categoryCompletion[cat].c / categoryCompletion[cat].t) * 100 : 0);
            createOrUpdateChart('analytics-category-chart', 'doughnut', catLabels, [{ label: 'Completion %', data: catData, backgroundColor: catLabels.map(cat => chartCategoryColors[cat]), borderColor: '#ffffff' }], { plugins: { legend: { position: 'top' } } });
            createOrUpdateChart('analytics-hours-chart', 'bar', ['Weekly Hours'], [{ label: 'Planned', data: [weeklyHours.planned], backgroundColor: '#a5b4fc', borderRadius: 5 }, { label: 'Actual', data: [weeklyHours.actual], backgroundColor: '#5eead4', borderRadius: 5 }]);
        }
        function updatePlanVisuals() {
            const allTasks = Object.values(schedule).flat(), totalWeeklyHours = allTasks.reduce((sum, task) => sum + task.duration, 0), completedWeeklyHours = allTasks.reduce((sum, task) => (taskStates[task.id]?.completed ? sum + task.duration : sum), 0), weeklyProgressPercent = totalWeeklyHours > 0 ? (completedWeeklyHours / totalWeeklyHours) * 100 : 0;
            const progressBar = document.getElementById('plan-weekly-progress'); progressBar.style.width = `${weeklyProgressPercent}%`; progressBar.textContent = `${Math.round(weeklyProgressPercent)}% Complete`;
            const categoryHours = { health: 0, personal: 0, work: 0, growth: 0, relax: 0 }; allTasks.forEach(task => categoryHours[task.category] += task.duration);
            createOrUpdateChart('plan-weekday-allocation-chart', 'pie', Object.keys(categoryHours), [{ data: Object.values(categoryHours), backgroundColor: Object.keys(categoryHours).map(cat => chartCategoryColors[cat]), borderColor: '#ffffff'}]);
            const categoryPoints = { health: 0, personal: 0, work: 0, growth: 0, relax: 0 }; allTasks.forEach(task => categoryPoints[task.category] += task.points);
            createOrUpdateChart('plan-growth-focus-chart', 'bar', Object.keys(categoryPoints), [{ label: 'Potential Earnings ($)/Week', data: Object.values(categoryPoints), backgroundColor: '#5eead4' }], { indexAxis: 'y', plugins: { legend: { display: false } } });
        }

        // --- Modal & Event Listeners ---
        function openModal(taskId) {
            modal.dataset.currentTaskId = taskId || ''; cancelDeletePrompt();
            customTimeInputs.classList.add('hidden');
            durationButtonsContainer.classList.remove('hidden');
            timeSlotContainer.classList.add('hidden');
            customTimeToggleBtn.textContent = 'Or Set Custom Time';
            populateTaskSuggestions();
            if (taskId) {
                const day = findTaskDay(taskId), task = schedule[day].find(t => t.id == taskId); if (!task) return;
                modalTitle.textContent = task.title; document.getElementById('modal-task-time').textContent = task.time;
                document.getElementById('pomodoro-timer').classList.toggle('hidden', !task.pomodoro); if(task.pomodoro) pomodoro.reset();
                const completeBtn = document.getElementById('complete-task-btn');
                if(taskStates[task.id]?.completed){ completeBtn.textContent = `Mark as Incomplete (-$${task.points})`; completeBtn.className = "bg-amber-500 text-white w-full py-3 rounded-lg font-bold hover:bg-amber-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105"; } else { completeBtn.textContent = `Mark as Complete (+$${task.points})`; completeBtn.className = "btn-primary text-white w-full py-3 rounded-lg font-bold shadow-md hover:shadow-lg transform hover:scale-105 transition-all"; }
                showModalContent('view');
            } else { modalTitle.textContent = "Add New Task"; modalTaskForm.reset(); daySelectInModal.value = today; updateDurationButtons(today); showModalContent('form'); }
            modal.classList.remove('hidden'); setTimeout(() => { modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
        }
        function showModalContent(mode) { if (mode === 'form') { modalViewContent.classList.add('hidden'); modalFormContent.classList.remove('hidden'); } else { modalViewContent.classList.remove('hidden'); modalFormContent.classList.add('hidden'); } }
        function populateFormForEdit() {
            const taskId = modal.dataset.currentTaskId; if (!taskId) return;
            const day = findTaskDay(taskId), task = schedule[day].find(t => t.id == taskId);
            document.getElementById('modal-task-title-input').value = task.title; daySelectInModal.value = day; document.getElementById('modal-task-category').value = task.category; const [startTime, endTime] = task.time.split(' - '); document.getElementById('modal-task-start-time').value = startTime; document.getElementById('modal-task-end-time').value = endTime; document.getElementById('modal-task-points').value = task.points; document.getElementById('modal-task-pomodoro').checked = task.pomodoro;
            updateDurationButtons(day, taskId);
            modalTitle.textContent = "Edit Task"; showModalContent('form');
        }
        function closeModal() { pomodoro.stop(); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); cancelDeletePrompt(); }, 300); }
        function setupDashboardEventListeners() {
            document.getElementById('add-new-task-main').addEventListener('click', () => openModal(null));
            document.getElementById('timetable-grid').addEventListener('click', e => { const card = e.target.closest('.task-card'); if (card) openModal(card.dataset.taskId); });
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', e => { if(e.target.id === 'task-modal') closeModal(); });
            pomodoro.startPauseBtn.addEventListener('click', () => { pomodoro.isRunning ? pomodoro.pause() : pomodoro.start(); });
            document.getElementById('reset-btn').addEventListener('click', () => pomodoro.reset());
            document.getElementById('complete-task-btn').addEventListener('click', () => { const taskId = modal.dataset.currentTaskId; if(!taskStates[taskId]) taskStates[taskId] = { completed: false }; taskStates[taskId].completed = !taskStates[taskId].completed; saveTaskStates(); renderTimetable(); updateAll(); closeModal(); });
            document.getElementById('edit-task-btn').addEventListener('click', populateFormForEdit);
            document.getElementById('delete-task-btn').addEventListener('click', promptForDelete);
            document.getElementById('confirm-delete-btn').addEventListener('click', executeDelete);
            document.getElementById('cancel-delete-btn').addEventListener('click', cancelDeletePrompt);
            document.getElementById('cancel-edit-btn').addEventListener('click', () => { if (modal.dataset.currentTaskId) { showModalContent('view'); } else { closeModal(); } });
            modalTaskForm.addEventListener('submit', handleSaveTask);
            daySelectInModal.addEventListener('change', (e) => updateDurationButtons(e.target.value, modal.dataset.currentTaskId));
            customTimeToggleBtn.addEventListener('click', () => { const isHidden = customTimeInputs.classList.contains('hidden'); customTimeInputs.classList.toggle('hidden'); durationButtonsContainer.classList.toggle('hidden'); timeSlotContainer.classList.add('hidden'); customTimeToggleBtn.textContent = isHidden ? 'Use Suggestions' : 'Set Custom Time'; });
            durationButtonsContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && !e.target.disabled) { durationButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); const duration = parseInt(e.target.dataset.duration); populateTimeSlotsForDuration(daySelectInModal.value, duration, modal.dataset.currentTaskId); } });
            timeSlotDropdown.addEventListener('change', (e) => { const selectedOption = e.target.options[e.target.selectedIndex]; if (selectedOption.dataset.startTime) { document.getElementById('modal-task-start-time').value = selectedOption.dataset.startTime; document.getElementById('modal-task-end-time').value = selectedOption.dataset.endTime; } });
            taskSuggestionButtonsContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { document.getElementById('modal-task-title-input').value = e.target.dataset.taskName; taskSuggestionButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); } });
            document.querySelectorAll('.tab-btn').forEach(button => { button.addEventListener('click', () => { document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden')); const activeTab = document.getElementById(button.dataset.tab); activeTab.classList.remove('hidden'); if (button.dataset.tab === 'analytics') updateAnalytics(); if (button.dataset.tab === 'plan') updatePlanVisuals(); }); });
        }
        init();
    });
    </script>
</body>
</html>
